<link rel="stylesheet" href="/css/markdown.css">
<%
	f = File.open(Dir.pwd + "/data/bookmarks.log", "r").read
    
	bookmarks = {}
    db = SQLite3::Database.open(Dir.pwd + "/data/bookmarks.db")
    db.execute("SELECT * FROM bookmarks ORDER BY watched_time DESC") do |row|
    	bookmarks[row[0]] = {
      							:url => row[1],
      							:watched_time => row[2][0..-7],
      							:title => row[3],
      							:starred => (row[4] == 'true'),
      							:note => row[5]
      						}
    end
    db.close
	
	log = []
	h = Hash.new(0)
	table_log = <<TAB
visited time | url
-------------|-----
TAB
	f.scan(/^\[(.+?)\]\s(.+)$/).each do |m|
		log << {
			   	  visited_time: m[0],
			   	  url: m[1]
			   }
		h[m[1]] += 1
		table_log += "#{m[0]} | #{m[1]}\n"
	end
	
	table_frq = <<TAB
title | url | ❤️ | count
------|-----|----|------
TAB
	h.each do |url, count|
		title = bookmarks.select { |k, v| url == v[:url] }.values.first[:title].gsub('|', '--')
		fav = bookmarks.select { |k, v| url == v[:url] }.values.first[:starred]
		table_frq += "#{title} | #{url} | #{fav} | #{count}\n"
	end
	
	md = <<MD
# 書籤價值計算公式

- 每訪問過 1 次，`+1`；
- 加❤️，`+3`；
- （暫時就想到這麼多😓）

# TODO

- 在搜索書籤時按照「書籤價值」排序；
- 統計分析蒐藏書籤的主題詞；
- 分析各時段的關注點；
- 對書籤的主網站評價（比如：某個高質量的博主）；


# 訪問記錄

#{table_log}


# 訪問頁面統計

#{table_frq}

MD

%>

<%= Kramdown::Document.new(md).to_html %>