<link rel="stylesheet" href="/css/markdown.css">
<%
	f = File.open(Dir.pwd + "/data/bookmarks.log", "r").read
    
	bookmarks = {}
    db = SQLite3::Database.open(Dir.pwd + "/data/bookmarks.db")
    db.execute("SELECT * FROM bookmarks ORDER BY watched_time DESC") do |row|
    	bookmarks[row[0]] = {
      							:url => row[1],
      							:watched_time => row[2][0..-7],
      							:title => row[3],
      							:starred => (row[4] == 'true'),
      							:note => row[5]
      						}
    end
    db.close
	
	log = []
	h = Hash.new(0)
	
	table_log = <<TAB
visited time | url
-------------|-----
TAB

	f.scan(/^\[(.+?)\]\s(.+)$/).each do |m|
		log << {
			   	  visited_time: m[0],
			   	  url: m[1]
			   }
		h[m[1]] += 1
		table_log += "#{m[0]} | #{m[1]}\n"
	end
	
	table_frq = <<TAB
title | url | â¤ï¸ | count
------|-----|----|------
TAB
	h.sort_by{ |k, v| v }.reverse_each do |url, count|
		case url
		when /\/s\?q=(.+)/
			table_frq += "search: #{$1} | /s | - | #{count}\n"
		when /\/search\?word=(.+)/
			table_frq += "search: #{$1} | /search | - | #{count}\n"
		else
			sel = bookmarks.select { |k, v| url == v[:url] }
			if sel.empty?
				table_frq += "- | #{url} | - | #{count}\n"
			else
				bm = sel.values.first
				title = bm[:title].gsub('|', '--')
				fav = bm[:starred]
				table_frq += "#{title} | #{url} | #{fav} | #{count}\n"
			end
		end
		
		# %><%= bm %><br /><%
		
	end
	
	t = <<TAB
url | protocal | host | port | path | suffix | anchor | params
----|----------|------|------|------|--------|--------|--------
TAB
	websites = Hash.new(0)
	bookmarks.each do |k, v|
# 		m = v[:url].match(/
# 							(?<protocol>http(s)?)
# 							:\/\/
# 							(?<host>[\w-.]+)
# 							(:(?<port>\d{4}))?
# 							(?<path>(\/[\w-]+)*\/?)
# 							(\.(?<suffix>\w+))?
# 							(\#(?<anchor>[\w-]+))?
# 							(\?
# 							  (?<params>
# 							    (
# 							      (\w+=\w+)
# 							      (&(\w+=\w+))*
# 							    )
# 							  )
# 							)?
# 						  /x)
# 		t +=  "#{v[:url]} | #{m[:protocol]} | #{m[:host]} | #{m[:port]} | #{m[:path]} | #{m[:suffix]} | #{m[:anchor]} | #{m[:params]}\n"
# 		websites["#{m[:protocol]}://#{m[:host]}"] += 1
		case v[:url]
		when /https?:\/\/([\w.-]+)/
			websites[$1] += 1
		else
			websites["ERROR: #{v[:url]}"] += 1
		end
	end
#	%><%= Kramdown::Document.new(t).to_html %><%
	
	table_web = <<TAB
title | count
------|-------
TAB
	websites.sort_by{ |k, v| v }.reverse_each do |website, c|
		table_web += "[#{website}](#{website}) | #{c}\n"
	end
	
	md = <<MD
# æ›¸ç±¤åƒ¹å€¼è¨ˆç®—å…¬å¼

- åŠ ã€Œæ›¸ç±¤çš„è¨ªå•æ¬¡æ•¸ã€ï¼›
- å¦‚â¤ï¸ï¼Œ`+3`ï¼›
- åŠ ä¸Šã€Œæ ¹ç¶²ç«™[^root]çš„è’è—æ¬¡æ•¸ã€ï¼›
- ï¼ˆå€ŸåŠ©é£¯å¦ä¸Šçš„æ•¸æ“šé€²ä¸€æ­¥æä¾›æ”¯æ’ï¼‰
- ï¼ˆæš«æ™‚å°±æƒ³åˆ°é€™éº¼å¤šðŸ˜“ï¼‰

[^root]: å•é¡Œåœ¨æ–¼ã€Œå¦‚ä½•åˆ¤æ–·æ ¹ç¶²ç«™ã€ã€‚å› ç‚ºå¦‚æžœæ˜¯è¨—ç®¡é¡žç¶²ç«™ï¼Œæ ¹ç¶²ç«™ä¸¦éžåšä¸»æœ¬èº«ï¼ˆæ¯”å¦‚ï¼š`weibo.com`ï¼‰ã€‚

# TODO

- åœ¨æœç´¢æ›¸ç±¤æ™‚æŒ‰ç…§ã€Œæ›¸ç±¤åƒ¹å€¼ã€æŽ’åºï¼›
- çµ±è¨ˆåˆ†æžè’è—æ›¸ç±¤çš„ä¸»é¡Œè©žï¼›
- åˆ†æžå„æ™‚æ®µçš„é—œæ³¨é»žï¼›
- å°æ›¸ç±¤çš„ä¸»ç¶²ç«™è©•åƒ¹ï¼ˆæ¯”å¦‚ï¼šæŸå€‹é«˜è³ªé‡çš„åšä¸»ï¼‰ï¼›


# è¨ªå•è¨˜éŒ„

#{table_log}


# è¨ªå•é é¢çµ±è¨ˆ

#{table_frq}


# è¨ªå•ç¶²ç«™çµ±è¨ˆ

#{table_web}
MD

%>

<%= Kramdown::Document.new(md).to_html %>