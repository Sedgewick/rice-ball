<%
require 'digest'

db = SQLite3::Database.open(Dir.pwd + "/data/bookmarks.db")


ids = db.execute("SELECT id FROM bookmarks").flatten
# pp ids

unless @u.nil?
	id = Digest::MD5.hexdigest(@u)
	unless ids.include? id
		db.execute("INSERT INTO bookmarks (id, url, watched_time, title)
		            VALUES (?, ?, ?, ?)", [id, @u, Time.at(@tm).to_s], @tl)
	end
end

bookmarks = {}
db.execute("SELECT * FROM bookmarks ORDER BY watched_time DESC") do |row|
	bookmarks[row[0]] = {
							:url => row[1],
							:watched_time => row[2][0..-7],
							:title => row[3].gsub('(Saved)', '').gsub(/^\p{Z}*/, '')
						}
end

db.close

%>

<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <title>Sedgewick 的稍後讀</title>
    <style>
      body {
        padding: 10px;
        font-size: 14px;
      }

      h1 {
        font-size: 16px;
      }

      h2 {
        font-size: 20px;
        text-decoration: underline;
      }

      h3 {
        font-size: 20px;
      }

      section > header {
        margin-bottom: 10px;
      }

      section > header > h2 {
        font-size: 20px;
      }

      ul {
        list-style-position: inside;
        margin: 10px 0;
	    background-color: #fafafa;
	    border: 1px solid #ccc;
	    border-radius: 4px;
	    padding: 10px;
      }
	  
      li {
        list-style-position: inside;
        margin: 5px 0;
		color: #999;
		font-size: 12px;
      }
	  
	  li a {
		color: black;
		font-size: 15px;
	  }

      section p {
        margin: 15px 0 30px 0;
      }

      ul:hover {
        background-color: #fbf9e6;
      }
	  
	  
	  .ipicon {
	    transition: opacity 400ms cubic-bezier(.25,.46,.45,.94);
	    background-image: url(./images/ipicons.png);
	    background-repeat: no-repeat;
	    display: inline-block;
	    vertical-align: middle;
		
		
	  }
	  
	  .ipicon-delete {
  		width: 25px;
  		height: 25px;
  		background-position: -300px 0;
	  }
    </style>
  </head>
  <body>
    <header>
      <h1><a href="/">飯糰🍙</a> / 稍後讀</h1>
    </header>
    <section>
      <br /> <br />
      
	  <% bookmarks.each do |id, bm| %>
		<ul>
		  <li>
            <%= bm[:watched_time] %>
		  </li>
		  <li>
			<a target="_blank" href="<%= bm[:url] %>">
				<%= bm[:title] %>
			</a>
		  </li>
		  <li>
			<div class="article_actions">
				<a title="Permanently Delete" data-article-id="<%= id %>" href="/read-it-later/delete?id=<%= id %>">
					<span class="ipicon ipicon-delete"></span>
				</a>
			</div>	
		  </li>
		</ul>
	  <% end %>
		
    </section>
    <footer>
      <a href="mailto:yx.pu@live.com">yx.pu@live.com</a>
      <p>&copy; 抄襲自 Alexis Sellier</p>
    </footer>
  </body>
</html>

